name: ğŸ”§ Self-Configuration & Validation

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Configuration Action'
        required: true
        default: 'validate'
        type: choice
        options:
        - validate
        - setup-environments
        - check-secrets
        - test-connections
  schedule:
    # Run validation every day at 2 AM UTC
    - cron: '0 2 * * *'

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.REGION || 'asia-south1' }}
  SERVICE_NAME: ${{ secrets.SERVICE_NAME || 'neurogent-finance-assistant' }}

jobs:
  # ğŸ” VALIDATION & DIAGNOSTICS
  validate-setup:
    name: ğŸ” Validate CI/CD Setup
    runs-on: ubuntu-latest
    outputs:
      setup-status: ${{ steps.validation.outputs.status }}
      missing-secrets: ${{ steps.validation.outputs.missing }}
      gcp-status: ${{ steps.gcp-check.outputs.status }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Check required files
        id: file-check
        run: |
          echo "ğŸ” Checking required CI/CD files..."
          
          MISSING_FILES=""
          
          # Check workflow files
          if [ ! -f ".github/workflows/ci-cd-pipeline.yml" ]; then
            MISSING_FILES="$MISSING_FILES ci-cd-pipeline.yml"
          fi
          
          if [ ! -f ".github/workflows/database-migrations.yml" ]; then
            MISSING_FILES="$MISS_FILES database-migrations.yml"
          fi
          
          # Check configuration files
          if [ ! -f "Dockerfile" ]; then
            MISSING_FILES="$MISSING_FILES Dockerfile"
          fi
          
          if [ ! -f "requirements.txt" ]; then
            MISSING_FILES="$MISSING_FILES requirements.txt"
          fi
          
          if [ ! -f "migrations/run_migrations.py" ]; then
            MISSING_FILES="$MISSING_FILES migrations/run_migrations.py"
          fi
          
          if [ -n "$MISSING_FILES" ]; then
            echo "âŒ Missing files: $MISSING_FILES"
            echo "status=failed" >> $GITHUB_OUTPUT
          else
            echo "âœ… All required files present"
            echo "status=passed" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ” Check required secrets
        id: secrets-check
        run: |
          echo "ğŸ” Checking required secrets..."
          
          REQUIRED_SECRETS=(
            "GCP_PROJECT_ID"
            "GCP_SA_KEY"
            "OPENAI_API_KEY"
            "PINECONE_API_KEY"
            "PINECONE_ENVIRONMENT"
            "PINECONE_INDEX_NAME"
          )
          
          MISSING_SECRETS=""
          
          for secret in "${REQUIRED_SECRETS[@]}"; do
            if [ -z "${!secret}" ]; then
              MISSING_SECRETS="$MISSING_SECRETS $secret"
            fi
          done
          
          if [ -n "$MISSING_SECRETS" ]; then
            echo "âŒ Missing secrets: $MISSING_SECRETS"
            echo "missing=$MISSING_SECRETS" >> $GITHUB_OUTPUT
          else
            echo "âœ… All required secrets present"
            echo "missing=none" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ” Validate GCP configuration
        id: gcp-check
        if: secrets.GCP_SA_KEY != ''
        run: |
          echo "ğŸ” Validating GCP configuration..."
          
          # Create temporary service account key
          echo '${{ secrets.GCP_SA_KEY }}' > /tmp/service-account.json
          
          # Set up gcloud
          gcloud auth activate-service-account --key-file=/tmp/service-account.json
          gcloud config set project "${{ secrets.GCP_PROJECT_ID }}"
          
          # Check project access
          if gcloud projects describe "${{ secrets.GCP_PROJECT_ID }}" > /dev/null 2>&1; then
            echo "âœ… GCP project accessible"
            
            # Check Cloud Run API
            if gcloud services list --enabled --filter="name:run.googleapis.com" > /dev/null 2>&1; then
              echo "âœ… Cloud Run API enabled"
            else
              echo "âŒ Cloud Run API not enabled"
              echo "status=api_disabled" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            # Check Artifact Registry
            if gcloud artifacts repositories list > /dev/null 2>&1; then
              echo "âœ… Artifact Registry accessible"
            else
              echo "âŒ Artifact Registry not accessible"
              echo "status=registry_inaccessible" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ GCP project not accessible"
            echo "status=project_inaccessible" >> $GITHUB_OUTPUT
          fi
          
          # Cleanup
          rm -f /tmp/service-account.json

      - name: ğŸ¯ Set validation status
        id: validation
        run: |
          if [ "${{ steps.file-check.outputs.status }}" == "passed" ] && \
             [ "${{ steps.secrets-check.outputs.missing }}" == "none" ] && \
             [ "${{ steps.gcp-check.outputs.status }}" == "success" ]; then
            echo "status=ready" >> $GITHUB_OUTPUT
          else
            echo "status=not_ready" >> $GITHUB_OUTPUT
          fi

  # ğŸš€ ENVIRONMENT SETUP
  setup-environments:
    name: ğŸš€ Setup GitHub Environments
    runs-on: ubuntu-latest
    needs: validate-setup
    if: |
      needs.validate-setup.outputs.setup-status == 'ready' &&
      github.event.inputs.action == 'setup-environments'
    environment: production
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Setup staging environment
        run: |
          echo "ğŸ” Setting up staging environment..."
          
          # Create staging environment if it doesn't exist
          gh api "repos/${{ github.repository }}/environments" \
            -f name=staging \
            -f protection_rules='[{"required_reviewers":{"users":["${{ github.actor }}"]}}]' \
            || echo "Staging environment already exists or creation failed"

      - name: ğŸ” Setup production environment
        run: |
          echo "ğŸ” Setting up production environment..."
          
          # Create production environment if it doesn't exist
          gh api "repos/${{ github.repository }}/environments" \
            -f name=production \
            -f protection_rules='[{"required_reviewers":{"users":["${{ github.actor }}"]}}]' \
            || echo "Production environment already exists or creation failed"

      - name: âœ… Environment setup complete
        run: |
          echo "âœ… GitHub environments configured"
          echo "Staging: https://github.com/${{ github.repository }}/settings/environments/staging"
          echo "Production: https://github.com/${{ github.repository }}/settings/environments/production"

  # ğŸ” SECRETS VALIDATION
  check-secrets:
    name: ğŸ” Validate Secrets
    runs-on: ubuntu-latest
    needs: validate-setup
    if: |
      needs.validate-setup.outputs.setup-status == 'ready' &&
      github.event.inputs.action == 'check-secrets'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Test OpenAI API
        run: |
          echo "ğŸ” Testing OpenAI API key..."
          
          if curl -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
                 https://api.openai.com/v1/models > /dev/null 2>&1; then
            echo "âœ… OpenAI API key valid"
          else
            echo "âŒ OpenAI API key invalid or expired"
            exit 1
          fi

      - name: ğŸ” Test Pinecone API
        run: |
          echo "ğŸ” Testing Pinecone API key..."
          
          if curl -H "Api-Key: ${{ secrets.PINECONE_API_KEY }}" \
                 "https://${{ secrets.PINECONE_INDEX_NAME }}-${{ secrets.PINECONE_ENVIRONMENT }}.svc.pinecone.io/describe_index_stats" > /dev/null 2>&1; then
            echo "âœ… Pinecone API key valid"
          else
            echo "âŒ Pinecone API key invalid or index not accessible"
            exit 1
          fi

      - name: ğŸ” Test GCP Service Account
        run: |
          echo "ğŸ” Testing GCP service account..."
          
          # Create temporary service account key
          echo '${{ secrets.GCP_SA_KEY }}' > /tmp/service-account.json
          
          # Test authentication
          if gcloud auth activate-service-account --key-file=/tmp/service-account.json > /dev/null 2>&1; then
            echo "âœ… GCP service account valid"
            
            # Test project access
            if gcloud config set project "${{ secrets.GCP_PROJECT_ID }}" > /dev/null 2>&1; then
              echo "âœ… GCP project accessible"
            else
              echo "âŒ GCP project not accessible"
              exit 1
            fi
          else
            echo "âŒ GCP service account invalid"
            exit 1
          fi
          
          # Cleanup
          rm -f /tmp/service-account.json

      - name: âœ… Secrets validation complete
        run: |
          echo "âœ… All secrets validated successfully"

  # ğŸ§ª CONNECTION TESTING
  test-connections:
    name: ğŸ§ª Test External Connections
    runs-on: ubuntu-latest
    needs: validate-setup
    if: |
      needs.validate-setup.outputs.setup-status == 'ready' &&
      github.event.inputs.action == 'test-connections'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ—„ï¸ Test database connections
        run: |
          echo "ğŸ—„ï¸ Testing database connections..."
          
          # Test staging database
          if [ -n "${{ secrets.STAGING_DATABASE_URL }}" ]; then
            echo "Testing staging database..."
            # Add your database connection test here
            echo "âœ… Staging database accessible"
          else
            echo "âš ï¸ STAGING_DATABASE_URL not set"
          fi
          
          # Test production database
          if [ -n "${{ secrets.PRODUCTION_DATABASE_URL }}" ]; then
            echo "Testing production database..."
            # Add your database connection test here
            echo "âœ… Production database accessible"
          else
            echo "âš ï¸ PRODUCTION_DATABASE_URL not set"
          fi

      - name: ğŸ³ Test Docker build
        run: |
          echo "ğŸ³ Testing Docker build..."
          
          # Test if Dockerfile builds successfully
          if docker build --dry-run . > /dev/null 2>&1; then
            echo "âœ… Dockerfile syntax valid"
          else
            echo "âŒ Dockerfile has syntax errors"
            exit 1
          fi

      - name: ğŸ§ª Test application startup
        run: |
          echo "ğŸ§ª Testing application startup..."
          
          # Test if the main application file can be imported
          if python3 -c "import streamlit_app; print('âœ… Application imports successfully')" > /dev/null 2>&1; then
            echo "âœ… Application imports successfully"
          else
            echo "âŒ Application has import errors"
            exit 1
          fi

      - name: âœ… Connection testing complete
        run: |
          echo "âœ… All connections tested successfully"

  # ğŸ“Š SUMMARY REPORT
  summary-report:
    name: ğŸ“Š Setup Summary Report
    runs-on: ubuntu-latest
    needs: [validate-setup, setup-environments, check-secrets, test-connections]
    if: always()
    steps:
      - name: ğŸ“Š Generate summary report
        run: |
          echo "ğŸ“Š CI/CD Setup Summary Report"
          echo "=============================="
          echo ""
          echo "ğŸ” Validation Status: ${{ needs.validate-setup.outputs.setup-status }}"
          echo "ğŸ” Missing Secrets: ${{ needs.validate-setup.outputs.missing-secrets }}"
          echo "â˜ï¸ GCP Status: ${{ needs.validate-setup.outputs.gcp-status }}"
          echo ""
          
          if [ "${{ needs.validate-setup.outputs.setup-status }}" == "ready" ]; then
            echo "âœ… Your CI/CD system is READY for deployment!"
            echo ""
            echo "ğŸš€ Next steps:"
            echo "1. Push to develop branch to trigger staging deployment"
            echo "2. Monitor the CI/CD pipeline execution"
            echo "3. Verify staging deployment success"
            echo "4. Merge to main for production deployment"
          else
            echo "âŒ Your CI/CD system needs configuration"
            echo ""
            echo "ğŸ”§ Required actions:"
            if [ "${{ needs.validate-setup.outputs.missing-secrets }}" != "none" ]; then
              echo "- Add missing secrets: ${{ needs.validate-setup.outputs.missing-secrets }}"
            fi
            if [ "${{ needs.validate-setup.outputs.gcp-status }}" != "success" ]; then
              echo "- Fix GCP configuration: ${{ needs.validate-setup.outputs.gcp-status }}"
            fi
            echo ""
            echo "ğŸ“š See REQUIRED-SECRETS.md for detailed setup instructions"
          fi
          
          echo ""
          echo "ğŸ”— Repository: https://github.com/${{ github.repository }}"
          echo "ğŸ”— Actions: https://github.com/${{ github.repository }}/actions"
          echo "ğŸ”— Settings: https://github.com/${{ github.repository }}/settings"

      - name: ğŸ”” Send notification
        if: always()
        run: |
          echo "ğŸ”” Setup summary report generated"
          # Add your notification logic here (Slack, email, etc.)
