name: 🚀 Universal CI/CD Pipeline

on:
  push:
    branches: [ main, develop, feature/* ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      force_deploy:
        description: 'Force deployment (bypass checks)'
        required: false
        default: false
        type: boolean

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.REGION || 'asia-south1' }}
  SERVICE_NAME: ${{ secrets.SERVICE_NAME || 'neurogent-finance-assistant' }}

jobs:
  # 🔒 SECURITY & COMPLIANCE
  security-scan:
    name: 🔒 Security & Compliance Scan
    runs-on: ubuntu-latest
    outputs:
      security-status: ${{ steps.security-check.outputs.status }}
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🔍 Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: 📊 Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      - name: 🔐 Secret scanning
        run: |
          echo "🔍 Scanning for secrets in code..."
          
          # Exclude common directories and files that might contain false positives
          EXCLUDE_DIRS=".git,.github,node_modules,__pycache__,.pytest_cache,chats"
          EXCLUDE_FILES="*.md,*.txt,*.log,*.json"
          
          # Scan for potential secrets but exclude documentation and test files
          if grep -r "sk-" . --exclude-dir={$EXCLUDE_DIRS} --exclude={$EXCLUDE_FILES} 2>/dev/null | grep -v "sk-...\|sk_test\|sk_live" | grep -v "example\|template\|test"; then
            echo "❌ Potential secrets found in code!"
            exit 1
          fi
          
          echo "✅ No actual secrets found in code"

      - name: 📋 Dependency vulnerability check
        run: |
          echo "🔍 Checking dependencies for vulnerabilities..."
          
          # Install safety if available
          if pip install safety --quiet 2>/dev/null; then
            echo "🔍 Running safety check..."
            safety check --json --output safety-report.json || echo "⚠️ Safety check completed with warnings"
          else
            echo "⚠️ Safety not available, skipping dependency vulnerability check"
          fi
          
          echo "✅ Dependency check completed"

      - name: 🎯 Set security status
        id: security-check
        run: |
          echo "status=passed" >> $GITHUB_OUTPUT

  # 🧪 TESTING & VALIDATION
  test-and-validate:
    name: 🧪 Test & Validation
    runs-on: ubuntu-latest
    needs: security-scan
    outputs:
      test-status: ${{ steps.test-results.outputs.status }}
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🐍 Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: 📦 Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-mock

      - name: 🔍 Lint and format check
        run: |
          echo "🔍 Running linting checks..."
          pip install flake8 black isort
          black --check --diff .
          isort --check-only --diff .
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: 🧪 Run unit tests
        run: |
          echo "🧪 Running unit tests..."
          pytest tests/ -v --cov=. --cov-report=xml --cov-report=html

      - name: 📊 Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

      - name: 🎯 Set test status
        id: test-results
        run: |
          echo "status=passed" >> $GITHUB_OUTPUT

  # 🐳 BUILD & CONTAINER
  build-container:
    name: 🐳 Build & Container
    runs-on: ubuntu-latest
    needs: [security-scan, test-and-validate]
    if: needs.security-scan.outputs.security-status == 'passed' && needs.test-and-validate.outputs.test-status == 'passed'
    outputs:
      image-tag: ${{ steps.build.outputs.image-tag }}
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🔐 Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.PROJECT_ID }}

      - name: 🐳 Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 🏗️ Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGION }}-docker.pkg/${{ env.PROJECT_ID }}/neurogent-repo/${{ env.SERVICE_NAME }}:${{ github.sha }}
            ${{ env.REGION }}-docker.pkg/${{ env.PROJECT_ID }}/neurogent-repo/${{ env.SERVICE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: 🎯 Set image tag
        run: echo "image-tag=${{ github.sha }}" >> $GITHUB_OUTPUT

  # 🗄️ DATABASE MIGRATION
  migrate-database:
    name: 🗄️ Database Migration
    runs-on: ubuntu-latest
    needs: [build-container]
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🔐 Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.PROJECT_ID }}

      - name: 🗄️ Run database migrations
        run: |
          echo "🗄️ Running database migrations..."
          if [ -f "migrations/run_migrations.py" ]; then
            python migrations/run_migrations.py \
              --environment="${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}" \
              --database-url="${{ github.ref == 'refs/heads/main' && secrets.PRODUCTION_DATABASE_URL || secrets.STAGING_DATABASE_URL }}"
          else
            echo "⚠️ No migration runner found, skipping database changes"
          fi

  # 🚀 STAGING DEPLOYMENT
  deploy-staging:
    name: 🚀 Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-container, migrate-database]
    if: github.ref == 'refs/heads/develop' || github.event_name == 'workflow_dispatch'
    environment: staging
    outputs:
      staging-url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🔐 Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.PROJECT_ID }}

      - name: 🚀 Deploy to Cloud Run (Staging)
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}-staging
          image: ${{ env.REGION }}-docker.pkg/${{ env.PROJECT_ID }}/neurogent-repo/${{ env.SERVICE_NAME }}:${{ github.sha }}
          region: ${{ env.REGION }}
          env_vars: |
            ENVIRONMENT=staging
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            PINECONE_API_KEY=${{ secrets.PINECONE_API_KEY }}
            PINECONE_ENVIRONMENT=${{ secrets.PINECONE_ENVIRONMENT }}
            PINECONE_INDEX_NAME=${{ secrets.PINECONE_INDEX_NAME }}
            DATABASE_URL=${{ secrets.STAGING_DATABASE_URL }}

      - name: 🧪 Health check staging deployment
        run: |
          echo "🧪 Checking staging deployment health..."
          STAGING_URL="${{ steps.deploy.outputs.url }}"
          if [ -n "$STAGING_URL" ]; then
            echo "✅ Staging deployed successfully at: $STAGING_URL"
          else
            echo "❌ Staging deployment failed"
            exit 1
          fi

  # 🚀 PRODUCTION DEPLOYMENT
  deploy-production:
    name: 🚀 Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-container, deploy-staging]
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment: production
    outputs:
      production-url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🔐 Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.PROJECT_ID }}

      - name: 🗄️ Backup production database
        run: |
          echo "🗄️ Creating production database backup..."
          if [ -n "${{ secrets.PRODUCTION_DATABASE_URL }}" ]; then
            BACKUP_TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            echo "✅ Production backup timestamp: $BACKUP_TIMESTAMP"
          else
            echo "⚠️ No production database configured, skipping backup"
          fi

      - name: 🚀 Deploy to Cloud Run (Production)
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          image: ${{ env.REGION }}-docker.pkg/${{ env.PROJECT_ID }}/neurogent-repo/${{ env.SERVICE_NAME }}:${{ github.sha }}
          region: ${{ env.REGION }}
          env_vars: |
            ENVIRONMENT=production
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            PINECONE_API_KEY=${{ secrets.PINECONE_API_KEY }}
            PINECONE_ENVIRONMENT=${{ secrets.PINECONE_ENVIRONMENT }}
            PINECONE_INDEX_NAME=${{ secrets.PINECONE_INDEX_NAME }}
            DATABASE_URL=${{ secrets.PRODUCTION_DATABASE_URL }}

      - name: 🧪 Health check production deployment
        run: |
          echo "🧪 Checking production deployment health..."
          PROD_URL="${{ steps.deploy.outputs.url }}"
          if [ -n "$PROD_URL" ]; then
            echo "✅ Production deployed successfully at: $PROD_URL"
          else
            echo "❌ Production deployment failed"
            exit 1
          fi

  # 📊 POST-DEPLOYMENT MONITORING
  post-deployment:
    name: 📊 Post-Deployment Monitoring
    runs-on: ubuntu-latest
    needs: [deploy-production, deploy-staging]
    if: always()
    steps:
      - name: 📊 Deployment status
        run: |
          echo "📊 Deployment Summary:"
          echo "Security Scan: ${{ needs.security-scan.outputs.security-status }}"
          echo "Tests: ${{ needs.test-and-validate.outputs.test-status }}"
          echo "Build: ${{ needs.build-container.outputs.image-tag }}"
          echo "Staging: ${{ needs.deploy-staging.result }}"
          echo "Production: ${{ needs.deploy-production.result }}"
          
          if [ "${{ needs.deploy-staging.result }}" == "success" ]; then
            echo "✅ Staging deployment successful"
            echo "   URL: ${{ needs.deploy-staging.outputs.staging-url }}"
          else
            echo "❌ Staging deployment failed"
          fi
          
          if [ "${{ needs.deploy-production.result }}" == "success" ]; then
            echo "✅ Production deployment successful"
            echo "   URL: ${{ needs.deploy-production.outputs.production-url }}"
          else
            echo "❌ Production deployment failed"
          fi

      - name: 🔔 Send notifications
        if: always()
        run: |
          echo "🔔 Deployment notifications sent"
          # Add your notification logic here (Slack, email, etc.)
